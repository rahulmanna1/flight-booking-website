// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and user management
model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  password              String
  firstName             String
  lastName              String
  avatar                String?
  phone                 String?
  dateOfBirth           String?
  nationality           String?
  
  // Role and permissions
  role                  UserRole @default(USER)
  
  // User preferences stored as JSON
  preferences           String   @default("{\"currency\":\"USD\",\"language\":\"en\",\"notifications\":{\"email\":true,\"sms\":false,\"push\":true}}")
  
  // Frequent flyer numbers stored as JSON array
  frequentFlyerNumbers  String?  @default("[]")
  
  // Password reset
  resetToken            String?
  resetTokenExpiry      DateTime?
  
  // Timestamps
  createdAt             DateTime @default(now())
  lastLogin             DateTime?
  updatedAt             DateTime @updatedAt
  
  // Relations
  bookings              Booking[]
  priceAlerts           PriceAlert[]
  notifications         Notification[]
  
  @@index([role])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// Booking model for flight reservations
model Booking {
  id                    String      @id @default(cuid())
  bookingReference      String      @unique
  confirmationNumber    String      @unique
  status                BookingStatus @default(CONFIRMED)
  
  // User relationship
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Promo code relationship
  promoCodeId           String?
  promoCode             PromoCode?  @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)
  discountAmount        Float?      @default(0)
  
  // Flight information stored as JSON for flexibility
  flightData            String
  
  // Passenger information stored as JSON array
  passengers            String
  
  // Seat selections stored as JSON array (per passenger per flight segment)
  seatSelections        String?     @default("[]")
  
  // Meal preferences stored as JSON array (per passenger per flight segment)
  mealPreferences       String?     @default("[]")
  
  // Baggage information stored as JSON
  baggageInfo           String?     @default("{\"checked\":[],\"carry_on\":[]}")
  
  // Travel insurance details stored as JSON
  insuranceInfo         String?     @default("null")
  
  // Group booking indicator
  isGroupBooking        Boolean     @default(false)
  groupSize             Int?        @default(1)
  groupCoordinatorEmail String?
  
  // Trip type
  tripType              TripType    @default(ROUND_TRIP)
  
  // Pricing breakdown stored as JSON
  pricing               String
  
  // Contact information stored as JSON
  contactInfo           String
  
  // Payment information stored as JSON (sensitive data should be encrypted)
  paymentInfo           String
  
  // Total amount
  totalAmount           Float?
  
  // Timestamps
  bookingDate           DateTime    @default(now())
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  refunds               Refund[]
  modifications         BookingModification[]
  
  @@map("bookings")
}

enum BookingStatus {
  CONFIRMED
  PENDING
  PAYMENT_FAILED
  CANCELLED
  COMPLETED
  REFUNDED
}

// Promo Code model for discount management
model PromoCode {
  id                    String      @id @default(cuid())
  code                  String      @unique
  description           String
  
  // Discount configuration
  discountType          DiscountType
  discountValue         Float
  minPurchaseAmount     Float?
  maxDiscountAmount     Float?
  
  // Usage limits
  usageLimit            Int?
  usageCount            Int         @default(0)
  perUserLimit          Int?
  
  // Validity period
  validFrom             DateTime
  validUntil            DateTime
  
  // Restrictions stored as JSON arrays
  applicableRoutes      String?     @default("[]")
  applicableAirlines    String?     @default("[]")
  
  // User restrictions
  firstTimeOnly         Boolean     @default(false)
  
  // Status
  isActive              Boolean     @default(true)
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  bookings              Booking[]
  
  @@index([code])
  @@index([validFrom, validUntil])
  @@index([isActive])
  @@map("promo_codes")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  BUY_ONE_GET_ONE
}

// Price Alert model for flight price monitoring
model PriceAlert {
  id                    String      @id @default(cuid())
  
  // User relationship
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Flight search parameters
  origin                String
  destination           String
  departureDate         String
  returnDate            String?
  tripType              TripType    @default(ONE_WAY)
  
  // Passenger information stored as JSON
  passengers            String      @default("{\"adults\":1,\"children\":0,\"infants\":0}")
  
  cabinClass            CabinClass  @default(ECONOMY)
  
  // Alert settings
  targetPrice           Float
  currency              String      @default("USD")
  currentPrice          Float?
  isActive              Boolean     @default(true)
  alertType             AlertType   @default(PRICE_BELOW)
  frequency             AlertFrequency @default(DAILY)
  
  // Notification preferences
  emailNotifications    Boolean     @default(true)
  pushNotifications     Boolean     @default(true)
  
  // Price history stored as JSON array
  priceHistory          String      @default("[]")
  
  // Timestamps
  lastChecked           DateTime?
  expiresAt             DateTime?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  notifications         Notification[]
  
  @@map("price_alerts")
}

enum TripType {
  ONE_WAY
  ROUND_TRIP
  MULTI_CITY
}

enum CabinClass {
  ECONOMY
  PREMIUM_ECONOMY
  BUSINESS
  FIRST
}

enum AlertType {
  PRICE_DROP
  PRICE_BELOW
  PRICE_ABOVE
}

enum AlertFrequency {
  IMMEDIATE
  DAILY
  WEEKLY
}

// Notification model for price alerts and booking updates
model Notification {
  id                    String      @id @default(cuid())
  
  // User relationship
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Price alert relationship (optional - for price alert notifications)
  priceAlertId          String?
  priceAlert            PriceAlert? @relation(fields: [priceAlertId], references: [id], onDelete: Cascade)
  
  // Notification details
  type                  NotificationType
  title                 String
  message               String
  
  // Price change details (for price alerts)
  previousPrice         Float?
  currentPrice          Float?
  changeAmount          Float?
  changePercent         Float?
  
  // Notification delivery
  channels              String      @default("[]")
  
  // Status tracking
  readAt                DateTime?
  sentAt                DateTime?
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@map("notifications")
}

enum NotificationType {
  PRICE_DROP
  TARGET_REACHED
  PRICE_INCREASE
  BOOKING_CONFIRMATION
  BOOKING_REMINDER
  FLIGHT_DELAYED
  FLIGHT_CANCELLED
  CHECK_IN_REMINDER
  GENERAL
}

// Flight data model for caching and search optimization
model Flight {
  id                    String      @id @default(cuid())
  
  // Basic flight information
  airline               String
  flightNumber          String
  aircraftType          String?
  
  // Route information
  origin                String
  destination           String
  departureTime         String
  arrivalTime           String
  departureDate         String
  arrivalDate           String?
  duration              String
  stops                 Int         @default(0)
  
  // Pricing and availability
  basePrice             Float
  currency              String      @default("USD")
  availableSeats        Int?
  
  // Cabin classes with pricing stored as JSON
  cabinClasses          String      @default("{}")
  
  // Additional flight details stored as JSON
  additionalInfo        String      @default("{}")
  
  // Cache metadata
  validUntil            DateTime
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Indexes for search optimization
  @@index([origin, destination, departureDate])
  @@index([airline, flightNumber])
  @@index([validUntil])
  @@map("flights")
}

// Session model for authentication tokens (optional - if not using JWT)
model Session {
  id                    String      @id @default(cuid())
  sessionToken          String      @unique
  userId                String
  expires               DateTime
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@map("sessions")
}

// Airport data model for search and autocomplete
model Airport {
  id                    String      @id @default(cuid())
  iataCode              String      @unique
  icaoCode              String?
  name                  String
  city                  String
  country               String
  countryCode           String
  timezone              String?
  latitude              Float?
  longitude             Float?
  elevation             Int?
  
  // Additional airport information stored as JSON
  additionalInfo        String      @default("{}")
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Indexes for search optimization
  @@index([iataCode])
  @@index([city, country])
  @@index([name])
  @@map("airports")
}

// API Provider Configuration for dynamic flight API switching
model ApiProvider {
  id                    String      @id @default(cuid())
  
  // Provider information
  name                  String      @unique
  displayName           String
  provider              ProviderType
  
  // API Credentials (encrypted)
  credentials           String
  
  // Configuration
  environment           String      @default("test")
  isActive              Boolean     @default(false)
  isPrimary             Boolean     @default(false)
  
  // Rate limiting
  requestsPerMinute     Int         @default(100)
  requestsPerDay        Int         @default(10000)
  
  // Usage tracking
  totalRequests         Int         @default(0)
  successfulRequests    Int         @default(0)
  failedRequests        Int         @default(0)
  lastUsedAt            DateTime?
  
  // Health monitoring
  isHealthy             Boolean     @default(true)
  lastHealthCheck       DateTime?
  healthCheckDetails    String?     @default("{}")
  
  // Features supported by this provider
  supportedFeatures     String      @default("[]")
  
  // Priority for fallback (lower = higher priority)
  priority              Int         @default(100)
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([isPrimary, isActive])
  @@index([provider])
  @@map("api_providers")
}

enum ProviderType {
  AMADEUS
  SKYSCANNER
  KIWI
  SABRE
  TRAVELPORT
  CUSTOM
}

// System Configuration for global settings
model SystemConfig {
  id                    String      @id @default(cuid())
  key                   String      @unique
  value                 String
  description           String?
  category              String      @default("general")
  isEncrypted           Boolean     @default(false)
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([category])
  @@map("system_config")
}

// Audit Log for tracking admin actions and system events
model AuditLog {
  id                    String      @id @default(cuid())
  
  // Action details
  action                String
  category              AuditCategory
  severity              AuditSeverity @default(INFO)
  
  // User information
  userId                String?
  userEmail             String?
  userRole              String?
  
  // Request details
  ipAddress             String?
  userAgent             String?
  endpoint              String?
  method                String?
  
  // Action details stored as JSON
  details               String      @default("{}")
  metadata              String?     @default("{}")
  
  // Timestamps
  createdAt             DateTime    @default(now())
  
  @@index([userId])
  @@index([category, severity])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditCategory {
  USER_AUTH
  USER_MANAGEMENT
  BOOKING_CREATE
  BOOKING_UPDATE
  BOOKING_CANCEL
  PAYMENT
  REFUND
  API_PROVIDER_CHANGE
  SYSTEM_CONFIG
  SECURITY
  PROMO_CODE
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// Refund model for managing booking refunds
model Refund {
  id                    String      @id @default(cuid())
  refundReference       String      @unique
  
  // Booking relationship
  bookingId             String
  booking               Booking     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  // User relationship
  userId                String
  
  // Refund details
  status                RefundStatus @default(PENDING)
  reason                String
  refundType            RefundType   @default(FULL)
  
  // Financial details
  requestedAmount       Float
  approvedAmount        Float?
  processingFee         Float?      @default(0)
  netRefundAmount       Float?
  
  // Payment information
  originalPaymentMethod String?
  refundMethod          String?     @default("ORIGINAL_METHOD")
  transactionId         String?
  
  // Dates
  requestedAt           DateTime    @default(now())
  processedAt           DateTime?
  completedAt           DateTime?
  
  // Admin handling
  processedBy           String?
  adminNotes            String?
  
  // Supporting documents stored as JSON array
  attachments           String?     @default("[]")
  
  // Additional metadata
  metadata              String?     @default("{}")
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([bookingId])
  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("refunds")
}

enum RefundStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED
}

enum RefundType {
  FULL
  PARTIAL
  CANCELLATION_FEE
}

// Booking Modification model for tracking changes to bookings
model BookingModification {
  id                    String      @id @default(cuid())
  modificationReference String      @unique
  
  // Booking relationship
  bookingId             String
  booking               Booking     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  // Modification details
  modificationType      ModificationType
  status                ModificationStatus @default(PENDING)
  
  // Original vs Modified data stored as JSON
  originalData          String
  modifiedData          String
  
  // Financial impact
  changeFee             Float?      @default(0)
  priceDifference       Float?      @default(0)
  totalCharge           Float?      @default(0)
  
  // Processing
  requestedBy           String      // User ID
  processedBy           String?     // Admin ID
  reason                String?
  adminNotes            String?
  
  // Dates
  requestedAt           DateTime    @default(now())
  processedAt           DateTime?
  completedAt           DateTime?
  
  // Additional metadata
  metadata              String?     @default("{}")
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([bookingId])
  @@index([status])
  @@index([requestedAt])
  @@map("booking_modifications")
}

enum ModificationType {
  FLIGHT_CHANGE
  PASSENGER_UPDATE
  SEAT_CHANGE
  MEAL_CHANGE
  BAGGAGE_CHANGE
  CONTACT_UPDATE
  CANCELLATION
}

enum ModificationStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
  CANCELLED
}
